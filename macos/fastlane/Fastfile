# This file contains the fastlane.tools configuration
# For macOS App Store builds
# More information: https://docs.fastlane.tools

app_store_connect_api_key(
  key_id: "7FN57R567Z",
  issuer_id: "69a6de88-7946-47e3-e053-5b8c7c11a4d1",
  key_filepath: "/Users/smart/Projects/FlutterGimchi/fastlaneAuthKeys/AuthKey_7FN57R567Z.p8"
)

default_platform(:mac)

platform :mac do
  desc "Push a new release build to the Mac App Store"
  lane :release do
    cocoapods(
      clean_install: true,
      repo_update: false,
      silent: false
    )

    increment_build_number(xcodeproj: "Runner.xcodeproj")
    
    # Build macOS app for App Store
    # Build macOS app for App Store
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        signingStyle: "automatic",
        teamID: "NTCK5U8AWD"
      }
    )
    
    # Upload to App Store
    # Note: If you see 500 error after "UPLOAD SUCCEEDED", the upload actually succeeded
    # The error is from Apple's metrics logging service, not the actual upload
    begin
      upload_to_app_store(
        skip_metadata: true,
        skip_screenshots: true,
        skip_app_version_update: true,
        precheck_include_in_app_purchases: false,
        force: true,
        submission_information: {
          export_compliance: {
            uses_non_exempt_encryption: false
          }
        }
      )
    rescue => ex
      # Check if upload actually succeeded despite the error
      if ex.message.include?("UPLOAD SUCCEEDED") || ex.message.include?("Delivery UUID")
        UI.success("Upload succeeded! The error is from Apple's metrics service and can be ignored.")
        UI.message("Please check App Store Connect to confirm the build was uploaded.")
      else
        raise ex
      end
    end
  end
end

